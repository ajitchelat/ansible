
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for Citrix NetScaler Ansible 0.1">
      
      
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.1, mkdocs-material-1.4.1">
    
    
      
        <title>Templating the configuration file - Citrix NetScaler Ansible Docs</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-56ade86843.js"></script>
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-76741b64bc.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../.." title="Citrix NetScaler Ansible Docs" class="md-icon md-icon--home md-header-nav__button">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Using Generic Ansible Modules
                </span>
              
            
            Templating the configuration file
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          
        </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-icon md-icon--home md-nav__button"></i>
    
    Citrix NetScaler Ansible Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="NetScaler Ansible Docs" class="md-nav__link">
      NetScaler Ansible Docs
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      User Documentation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        User Documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../usage/getting-started/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../usage/speeding-up-execution/" title="Speeding up execution" class="md-nav__link">
      Speeding up execution
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../usage/rolling-upgrades/" title="Rolling upgrades" class="md-nav__link">
      Rolling upgrades
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../usage/rolling-upgrades-vpx/" title="Rolling upgrades (VPX)" class="md-nav__link">
      Rolling upgrades (VPX)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../usage/docker-image/" title="Netscaler ansible docker image" class="md-nav__link">
      Netscaler ansible docker image
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Using Generic Ansible Modules
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Using Generic Ansible Modules
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../about/" title="Using generic Ansible modules" class="md-nav__link">
      Using generic Ansible modules
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Templating the configuration file
      </label>
    
    <a href="./" title="Templating the configuration file" class="md-nav__link md-nav__link--active">
      Templating the configuration file
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#workflow" title="Workflow" class="md-nav__link">
    Workflow
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#playbook" title="Playbook" class="md-nav__link">
    Playbook
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#processing-the-template" title="Processing the template" class="md-nav__link">
    Processing the template
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-the-configuration-variables" title="Defining the configuration variables" class="md-nav__link">
    Defining the configuration variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upload-the-new-nsconf" title="Upload the new ns.conf" class="md-nav__link">
    Upload the new ns.conf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rebooting-netscaler" title="Rebooting Netscaler" class="md-nav__link">
    Rebooting Netscaler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-points" title="Final points" class="md-nav__link">
    Final points
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" title="References" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../nitro-api-calls/" title="Direct NITRO API calls" class="md-nav__link">
      Direct NITRO API calls
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Module Documentation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Module Documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/" title="Module index" class="md-nav__link">
      Module index
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/netscaler-cs-action-module/" title="netscaler_cs_action" class="md-nav__link">
      netscaler_cs_action
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/netscaler-cs-policy-module/" title="netscaler_cs_policy" class="md-nav__link">
      netscaler_cs_policy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/netscaler-cs-vserver-module/" title="netscaler_cs_vserver" class="md-nav__link">
      netscaler_cs_vserver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/netscaler-gslb-service-module/" title="netscaler_gslb_service" class="md-nav__link">
      netscaler_gslb_service
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/netscaler-gslb-site-module/" title="netscaler_gslb_site" class="md-nav__link">
      netscaler_gslb_site
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/netscaler-gslb-vserver-module/" title="netscaler_gslb_vserver" class="md-nav__link">
      netscaler_gslb_vserver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/netscaler-lb-monitor-module/" title="netscaler_lb_monitor" class="md-nav__link">
      netscaler_lb_monitor
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/netscaler-lb-vserver-module/" title="netscaler_lb_vserver" class="md-nav__link">
      netscaler_lb_vserver
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/netscaler-save-config-module/" title="netscaler_save_config" class="md-nav__link">
      netscaler_save_config
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/netscaler-server-module/" title="netscaler_server" class="md-nav__link">
      netscaler_server
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/netscaler-service-module/" title="netscaler_service" class="md-nav__link">
      netscaler_service
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/netscaler-servicegroup-module/" title="netscaler_servicegroup" class="md-nav__link">
      netscaler_servicegroup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../modules/netscaler-ssl-certkey-module/" title="netscaler_ssl_certkey" class="md-nav__link">
      netscaler_ssl_certkey
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../development-utilities/" title="Developer Documentation" class="md-nav__link">
      Developer Documentation
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#workflow" title="Workflow" class="md-nav__link">
    Workflow
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#playbook" title="Playbook" class="md-nav__link">
    Playbook
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#processing-the-template" title="Processing the template" class="md-nav__link">
    Processing the template
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defining-the-configuration-variables" title="Defining the configuration variables" class="md-nav__link">
    Defining the configuration variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#upload-the-new-nsconf" title="Upload the new ns.conf" class="md-nav__link">
    Upload the new ns.conf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rebooting-netscaler" title="Rebooting Netscaler" class="md-nav__link">
    Rebooting Netscaler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-points" title="Final points" class="md-nav__link">
    Final points
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" title="References" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="templating-the-configuration-file"><a class="toclink" href="#templating-the-configuration-file">Templating the configuration file</a></h1>
<p>One method of configuring Netscaler consists of editing the ns.conf file
directly and then rebooting Netscaler for the configuration changes to
take effect.</p>
<p>After the reboot the saved configuration becomes the running
configuration which is what we want to change.</p>
<h2 id="workflow"><a class="toclink" href="#workflow">Workflow</a></h2>
<p>With this method we leverage Ansible's <a href="http://docs.ansible.com/ansible/latest/template_module.html">template module</a> to
produce a ns.conf file from a Jinja2 template.</p>
<p>The Jinja2 template is populated from configuration variables which can
be defined with various methods, inside the playbook, in an inventory
file or loaded from inventory files.</p>
<p>We then upload the resulting ns.conf to the Netscaler node which alters
the saved configuration.</p>
<p>For the saved configuration to become running configuration we need to
reboot Netscaler. Doing a warm reboot is recommended since it is
sufficient to reload the configuration and also avoid the greater
downtime a cold reboot would induce.</p>
<p>After the reboot the user can check the running configuration either
through the GUI or the command line interface and make sure the changes
have been succesfully applied.</p>
<p>There is an assortment of playbooks on this <a href="https://github.com/citrix/ansible-nitro-api-calls">github repository</a> which
contains sample playbooks that perform fundamental NITRO operations. The
tasks within each playbook can be combined into a larger playbook which
accomplishes a full Netscaler configuration.</p>
<p>In fact this is how the following example was constructed.</p>
<h2 id="playbook"><a class="toclink" href="#playbook">Playbook</a></h2>
<p>In the following example we showcase how we can setup a load balancer
which balances two backend services. The full content of the referenced
files can be found <a href="https://github.com/citrix/netscaler-rolling-updates-example">here</a>.</p>
<h3 id="processing-the-template"><a class="toclink" href="#processing-the-template">Processing the template</a></h3>
<p>First we have a Jinja template file to produce the desired ns.conf. It
is recommended to use an actual ns.conf file from the target Netscaler
node as a starting point for the template.</p>
<p>The full file is quite long but the interesting parts are shown below.</p>
<div class="codehilite"><pre><span></span><span class="nn">...</span>

<span class="c1"># Start of Jinja inserted servers</span>
<span class="p p-Indicator">{</span><span class="err">%</span> <span class="nv">for server in configuration.servers %</span><span class="p p-Indicator">}</span>
<span class="l l-Scalar l-Scalar-Plain">add server {{ server.name }} {{ server.ipaddress }}</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>
<span class="l l-Scalar l-Scalar-Plain"># End of Jinja inserted servers</span>

<span class="nn">...</span>

<span class="c1"># Start of Jinja inserted services</span>
<span class="p p-Indicator">{</span><span class="err">%</span> <span class="nv">for service in configuration.services %</span><span class="p p-Indicator">}</span>
<span class="l l-Scalar l-Scalar-Plain">add service {{ service.name }} {{ service.ipaddress }} {{ service.type }} {{ service.port }} -gslb NONE -maxClient 0 -maxReq 0 -cip DISABLED -usip NO -useproxyport YES -sp OFF -cltTimeout 180 -svrTimeout 360 -CKA NO -TCPB NO -CMP NO</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>
<span class="l l-Scalar l-Scalar-Plain"># End of Jinja inserted services</span>


<span class="nn">...</span>

<span class="c1"># Start of Jinja inserted lb vservers</span>
<span class="p p-Indicator">{</span><span class="err">%</span> <span class="nv">for vserver in configuration.lbvservers %</span><span class="p p-Indicator">}</span>
<span class="l l-Scalar l-Scalar-Plain">add lb vserver {{ vserver.name }} {{ vserver.type }} {{ vserver.ipaddress }} {{ vserver.port }} -persistenceType NONE -cltTimeout 180</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>
<span class="l l-Scalar l-Scalar-Plain"># End of Jinja inserted lb vservers</span>

<span class="nn">...</span>

<span class="c1"># Start of Jinja inserted lb vservers binds</span>
<span class="p p-Indicator">{</span><span class="err">%</span> <span class="nv">for bind in configuration.lbvserver_binds %</span><span class="p p-Indicator">}</span>
<span class="l l-Scalar l-Scalar-Plain">bind lb vserver {{ bind.server }} {{ bind.service }} -weight {{ bind.weight }}</span>
<span class="l l-Scalar l-Scalar-Plain">{% endfor %}</span>
<span class="l l-Scalar l-Scalar-Plain"># End of Jinja inserted lb vservers binds</span>
</pre></div>


<p>Essentially we iterate over items in the configuration dictionary. This
dictionary is populated from the playbook variables.</p>
<h3 id="defining-the-configuration-variables"><a class="toclink" href="#defining-the-configuration-variables">Defining the configuration variables</a></h3>
<p>The playbook variables are shown below.</p>
<div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">vars</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">filename</span><span class="p p-Indicator">:</span> <span class="s">&quot;ns.conf&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">filelocation</span><span class="p p-Indicator">:</span> <span class="s">&quot;/nsconfig&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">localfile</span><span class="p p-Indicator">:</span> <span class="s">&quot;/var/tmp/ns.conf&quot;</span>

  <span class="l l-Scalar l-Scalar-Plain">warm_reboot</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

  <span class="l l-Scalar l-Scalar-Plain">configuration</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">servers</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.1</span>
        <span class="l l-Scalar l-Scalar-Plain">ipaddress</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.1</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.2</span>
        <span class="l l-Scalar l-Scalar-Plain">ipaddress</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.2</span>

    <span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service-test-1</span>
        <span class="l l-Scalar l-Scalar-Plain">ipaddress</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.1</span>
        <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
        <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">HTTP</span>

      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service-test-2</span>
        <span class="l l-Scalar l-Scalar-Plain">ipaddress</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.1.2</span>
        <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
        <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">HTTP</span>

    <span class="l l-Scalar l-Scalar-Plain">lbvservers</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">server-test</span>
        <span class="l l-Scalar l-Scalar-Plain">ipaddress</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">10.78.60.203</span>
        <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
        <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">HTTP</span>

    <span class="l l-Scalar l-Scalar-Plain">lbvserver_binds</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">server</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">server-test</span>
        <span class="l l-Scalar l-Scalar-Plain">service</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service-test-1</span>
        <span class="l l-Scalar l-Scalar-Plain">weight</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">50</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">server</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">server-test</span>
        <span class="l l-Scalar l-Scalar-Plain">service</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service-test-2</span>
        <span class="l l-Scalar l-Scalar-Plain">weight</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">50</span>
</pre></div>


<p>The configuration dictionary is defined inside the playbook. This is
done for maintaining simplicity in the context of the example.</p>
<p>A more sophisticated setup could have defined the configuration
dictionary in a separate variables file, in the inventory file or use
any other method Ansible allows to define variables.</p>
<p>We also see the variables that configure the paths of the source and
target files. These could also be defined in the different ways the
configuration dictionary is defined.</p>
<h3 id="upload-the-new-nsconf"><a class="toclink" href="#upload-the-new-nsconf">Upload the new ns.conf</a></h3>
<p>Having produced the ns.conf file we need to upload it to Netscaler.</p>
<p>Following are the tasks that accomplish this.</p>
<div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Delete old ns.conf</span>
  <span class="l l-Scalar l-Scalar-Plain">delegate_to</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">uri</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="s">&quot;http://{{</span><span class="nv"> </span><span class="s">nsip</span><span class="nv"> </span><span class="s">}}/nitro/v1/config/systemfile?args=filename:{{</span><span class="nv"> </span><span class="s">filename</span><span class="nv"> </span><span class="s">}},filelocation:{{</span><span class="nv"> </span><span class="s">filelocation</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">replace(&#39;/&#39;,&#39;%2F&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">DELETE</span>
    <span class="l l-Scalar l-Scalar-Plain">status_code</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">200</span>
    <span class="l l-Scalar l-Scalar-Plain">return_content</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class="l l-Scalar l-Scalar-Plain">headers</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">X-NITRO-USER</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nitro_user</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">X-NITRO-PASS</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nitro_pass</span><span class="nv"> </span><span class="s">}}&quot;</span>

<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Upload new ns.conf</span>
  <span class="l l-Scalar l-Scalar-Plain">delegate_to</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">uri</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="s">&quot;http://{{</span><span class="nv"> </span><span class="s">nsip</span><span class="nv"> </span><span class="s">}}/nitro/v1/config/systemfile&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">POST</span>
    <span class="l l-Scalar l-Scalar-Plain">status_code</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">201</span>
    <span class="l l-Scalar l-Scalar-Plain">return_content</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class="l l-Scalar l-Scalar-Plain">headers</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">X-NITRO-USER</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nitro_user</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">X-NITRO-PASS</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nitro_pass</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">body_format</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">json</span>
    <span class="l l-Scalar l-Scalar-Plain">body</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">systemfile</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">filename</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">filename</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">filecontent</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(&#39;file&#39;,</span><span class="nv"> </span><span class="s">localfile)</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">b64encode</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">filelocation</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">filelocation</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>


<p>Notice that we need to delete the existing file before copying the new
one. Trying to upload a file to an existing file path will result in a
NITRO error.</p>
<h3 id="rebooting-netscaler"><a class="toclink" href="#rebooting-netscaler">Rebooting Netscaler</a></h3>
<p>The last step is to warm reboot the Netscaler node. Replacing the
ns.conf file overwrites the saved configuration. The running
configuration of Netscaler remains unaffected. To force Netscaler to
apply the saved configuration we need to reboot it. We have the option
do a warm reboot which results in less downtime than a full reboot.</p>
<p>The task that accomplishes this is shown below.</p>
<div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Reboot Netscaler</span>
  <span class="l l-Scalar l-Scalar-Plain">delegate_to</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class="l l-Scalar l-Scalar-Plain">uri</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="s">&quot;http://{{</span><span class="nv"> </span><span class="s">nsip</span><span class="nv"> </span><span class="s">}}/nitro/v1/config/reboot&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">method</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">POST</span>
    <span class="l l-Scalar l-Scalar-Plain">status_code</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">201</span>
    <span class="l l-Scalar l-Scalar-Plain">headers</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">X-NITRO-USER</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nitro_user</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">X-NITRO-PASS</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nitro_pass</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">body_format</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">json</span>
    <span class="l l-Scalar l-Scalar-Plain">body</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">reboot</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">warm</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">warm_reboot</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>


<h3 id="final-points"><a class="toclink" href="#final-points">Final points</a></h3>
<p>The user needs for this example to set the variables needed for
authentication and communication with Netscaler. Namely <code>nsip</code>,
<code>nitro_user</code>, <code>nitro_pass</code>. These variables retain the meaning they have
in the Netscaler specific Ansible modules.</p>
<p>All tasks are run with the <code>delegate_to: localhost</code> option set. This is
needed since we are making NITRO API calls to the Netscaler node. We do
not want to connect directly with SSH to it.</p>
<p>In some deployments the delegated host may need to be the bastion node
that has actual NITRO access to the Netscaler node.</p>
<h2 id="references"><a class="toclink" href="#references">References</a></h2>
<ul>
<li><a href="https://github.com/citrix/ansible-nitro-api-calls">Ansible NITRO API calls repository</a></li>
<li><a href="http://docs.ansible.com/ansible/latest/template_module.html">Ansible template module documentation</a></li>
</ul>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../about/" title="Using generic Ansible modules" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Using generic Ansible modules
              </span>
            </div>
          </a>
        
        
          <a href="../nitro-api-calls/" title="Direct NITRO API calls" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Direct NITRO API calls
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-3964c0cb56.js"></script>
      <script>app.initialize({url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>