<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
  <!--<![endif]-->

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">   
    <title>Rolling upgrades (VPX) - Citrix NetScaler Ansible Docs</title>
     
    <link rel="shortcut icon" href="
https://www.citrix.com/etc/designs/citrix/icon-favicon.png"> 
    <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
    <link rel="stylesheet" href="../../css/highlight.css">
    <link rel="stylesheet" href="../../css/override.css" type="text/css" />
    <link rel="stylesheet" href="../../css/font-awesome.css" type="text/css" /> 
    <script>
      // Current page data
      var mkdocs_page_name = "Rolling upgrades (VPX)";
      var mkdocs_page_input_path = "usage/rolling-upgrades-vpx.md";
      var mkdocs_page_url = "/usage/rolling-upgrades-vpx/";

    </script>
    
    <script src="../../js/jquery-2.1.1.min.js"></script>
    <script src="../../js/modernizr-2.8.3.min.js"></script>
    <script type="text/javascript" src="../../js/highlight.pack.js"></script>
    <script src="../../js/theme.js"></script>
    <script src="../../js/custom.js"></script>  
  </head>

  <body class="wy-body-for-nav" role="document">

    <div class="header-top">

        <div class="header-top-left">
          <a href="http://developer-docs.citrix.com" class="logo-position"><img height="60" src="../../img/citrixlogoblack.png" target="_blank" class="logo-citrix"><span style="color:#000;font-size: 20px;position: relative;top:4px;left:20px;">Developer Documentation</span></a>
        </div>
        <div class="header-top-right">
          <ul>

            <form id="rtd-search-form-alt" class="wy-form" action="../../search.html" method="get">
             <ul class="header-elements">
              <li class="list-inline support">
                <input name="q" id="txtName" type="text" placeholder="Search SDKs" class="searchdocs">
                <a class="fa fa-search errspan"></a>
<!---
              </li>
             <li> <a href="javascript:void(0);" style="font-size: 22px;position: relative;left: -10px;top: 3px"><i class="fa fa-globe"></i></a></li>
             </ul>
             --->
            </form>

          </ul>

        </div>

    </div>
    <div class="body">
      <div class="wy-grid-for-nav">

        
        <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
          <div class="wy-side-nav-search">
            <div role="search">
  <form id ="rtd-search-form-alt" class="wy-form" action="../../search.html" method="get">
	<i class="fa fa-search"></i>
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
          </div>

          <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
            <ul class="current">
              
              
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../..">NetScaler Ansible Docs</a>
		
    </li>

			  
              
    <li><span style="font-size: 16px;padding-left: 0px;">User Documentation <i class="faexp fa fa-angle-down" aria-hidden="true"></i></span></li>
    <ul class="subnav" style="margin-left: 0px;padding-left:15px;border-left: 1px solid #b2b2b2;">
        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../getting-started/">Getting Started</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../speeding-up-execution/">Speeding up execution</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../rolling-upgrades/">Rolling upgrades</a>
		
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="toctree-l1-a current" href="./">Rolling upgrades (VPX)</a>
		
            <ul style="margin-left: 0px;padding-left:15px;border-left: 1px solid #b2b2b2;">
            
                <li class="toctree-l3"><a href="#rolling-upgrades-vpx" style="padding:0px;position: relative;">&nbsp;Rolling upgrades (VPX)</a></li>
                
                    <li><a class="toctree-l4" href="#setup" style="padding:0px;position: relative;">Setup</a></li>
                
                    <li><a class="toctree-l4" href="#initializing-the-testbed" style="padding:0px;position: relative;">Initializing the testbed</a></li>
                
                    <li><a class="toctree-l4" href="#upgrade-process" style="padding:0px;position: relative;">Upgrade process</a></li>
                
                    <li><a class="toctree-l4" href="#references" style="padding:0px;position: relative;">References</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../docker-image/">Netscaler ansible docker image</a>
		
    </li>

        
    </ul>

			  
              
    <li><span style="font-size: 16px;padding-left: 0px;">Using Generic Ansible Modules <i class="faexp fa fa-angle-down" aria-hidden="true"></i></span></li>
    <ul class="subnav" style="margin-left: 0px;padding-left:15px;border-left: 1px solid #b2b2b2;">
        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../generic-modules/about/">Using generic Ansible modules</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../generic-modules/templating-configuration-file/">Templating the configuration file</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../generic-modules/nitro-api-calls/">Direct NITRO API calls</a>
		
    </li>

        
    </ul>

			  
              
    <li><span style="font-size: 16px;padding-left: 0px;">Module Documentation <i class="faexp fa fa-angle-down" aria-hidden="true"></i></span></li>
    <ul class="subnav" style="margin-left: 0px;padding-left:15px;border-left: 1px solid #b2b2b2;">
        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../modules/">Module index</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../modules/netscaler-cs-action-module/">netscaler_cs_action</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../modules/netscaler-cs-policy-module/">netscaler_cs_policy</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../modules/netscaler-cs-vserver-module/">netscaler_cs_vserver</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../modules/netscaler-gslb-service-module/">netscaler_gslb_service</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../modules/netscaler-gslb-site-module/">netscaler_gslb_site</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../modules/netscaler-gslb-vserver-module/">netscaler_gslb_vserver</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../modules/netscaler-lb-monitor-module/">netscaler_lb_monitor</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../modules/netscaler-lb-vserver-module/">netscaler_lb_vserver</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../modules/netscaler-save-config-module/">netscaler_save_config</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../modules/netscaler-server-module/">netscaler_server</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../modules/netscaler-service-module/">netscaler_service</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../modules/netscaler-servicegroup-module/">netscaler_servicegroup</a>
		
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../modules/netscaler-ssl-certkey-module/">netscaler_ssl_certkey</a>
		
    </li>

        
    </ul>

			  
              
    <li class="toctree-l1 ">
        <a class="toctree-l1-a " href="../../development-utilities/">Developer Documentation</a>
		
    </li>

			  
            </ul>
          </div>
          &nbsp;
        </nav>

        <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

           
          <div class="wy-nav-content">
            <div class="rst-content">
              <!-- <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>User Documentation &raquo;</li>
        
      
    
    <li>Rolling upgrades (VPX)</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div> -->
              <div role="main">
                <div class="section">
                <div class="file-format">
                 <div class="leftAlign" style="float: left;visibility: hidden;">
                  </div>
                  <div class="rightAlign" style="float: right;">
                      <span>Download full document:</span>
                      <ul class="file-types">
                        <li><a style="border: 1px solid #EE3D24;padding: 5px;font-size: 11px;color: #EE3D24;border-radius: 5px;font-weight: 700">PDF</a></li>
                        <li><a style="border: 1px solid #2A579A;padding: 5px;font-size: 11px;color: #2A579A;border-radius: 5px;font-weight: 700">DOCX</a></li>
                        <li><a style="border: 1px solid #495164;padding: 5px;font-size: 11px;color: #495164;border-radius: 5px;font-weight: 700">EMAIL</a></li>
                        <li><a style="border: 1px solid #495164;padding: 5px;font-size: 11px;color: #495164;border-radius: 5px;font-weight: 700">PRINT</a></li>
                      </ul>
                  </div>
                  </div>
                   <h1 id="rolling-upgrades-vpx"><a class="toclink" href="#rolling-upgrades-vpx">Rolling upgrades (VPX)</a></h1>
<p>This document demonstrates how to to a rolling upgrade with zero
downtime for a simple load balanced service.</p>
<p>The methods showcased here are also applicable to more complex
networking setups.</p>
<h2 id="setup"><a class="toclink" href="#setup">Setup</a></h2>
<p>The example utilizes Netscaler VPX and some virtualized hosts to provide
the back end web services.</p>
<p>The ansible playbooks along with other files needed to run this example
can be found at the following <a href="https://github.com/citrix/netscaler-rolling-updates-vpx-example">github
repository</a></p>
<p>The testbed required to run the examples is the following.</p>
<div class="codehilite"><pre><span></span>    +--------------------+
    | Netscaler VPX      |
    |                    | 192.168.10.2                  +----------+
    |               SNIP |&lt;-----------------------------&gt;| server 1 |
    |                    |              |  192.168.10.10 +----------+
    | NSIP          VIP  |              |                          ^
    +--------------------+              |                          |10.78.60.204
      ^              ^                  |            +----------+  |
      |10.78.60.202  |10.78.60.203      +-----------&gt;| server 2 |  |
      |              |                 192.168.10.11 +----------+  |
      |              |                                       ^     |
      |              |                           10.78.60.205|     |
      |              |                                       |     |
      |              |                                       |     |
      |              |                                       |     |
      |              |                                       |     |
      |=NITRO        |=HTTP                                  |     |
      |              |                                       |     |
      |              |     +-----------+             SSH     |     |
      +--------------+-----| user host |---------------------+-----+
                           +-----------+
</pre></div>


<p>We need a virtual host to run Netscaler VPX and we also need two hosts
to run the back end web services. These can be any kind of hosts, as
long as it is possible for the Netscaler node and the web server nodes
to communicate via a specified subnet. Having the backend servers as
virtual hosts on the same Xen Server as the Netscaler VPX is recommended
since it simplifies the networking setup needed.</p>
<p>In our example the back end servers and the Netscaler host communicate
via the <code>192.168.10.0/24</code> subnet.</p>
<p>Also there is a user host which is the machine that will run the
playbooks for this example. This host needs to be able to communicate
via SSH with the back end servers to be able to setup and update the web
services and also needs to be able to make NITRO API calls to the
Netscaler node on the configured NSIP.</p>
<p>Finally Netscaler needs to have a Virtual IP configured which will be
the client facing address of our load balanced service.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
</div>
<p>"Note
        The playbooks and scripts do not configure any of these ip addresses on the Netscaler node or the server nodes. You need to set them up prior to running the playbooks in this example and modify the <code>inventory.txt</code> file to match your particular configuration.</p>
<p>More details for the requirements of each node are included in the
README file of the <a href="https://github.com/citrix/netscaler-rolling-updates-vpx-example">github
repository</a>
containing this example's files.</p>
<h2 id="initializing-the-testbed"><a class="toclink" href="#initializing-the-testbed">Initializing the testbed</a></h2>
<p>Having setup the testbed and modified the inventory.txt file to match
the configured ip addresses we need to initialize the Netscaler and the
back end server nodes.</p>
<p>This is done by running on the user host from a fresh checkout of the
files from the <a href="https://github.com/citrix/netscaler-rolling-updates-vpx-example">github
repository</a>
by running the following command</p>
<div class="codehilite"><pre><span></span>ansible-playbook -i inventory.txt rolling_init.yaml
</pre></div>


<p>Running this playbook will initialize the back end services and also
configure the Netscaler in order to serve them over the VIP of the load
balancer.</p>
<p>The logical configuration of the Netscaler node can be seen in the
following diagram.</p>
<div class="codehilite"><pre><span></span>          +
          |
          |
          |
+---------V----------+
| Load balancer      |
| lb_vserver_1       |----------+
| 10.78.60.203:80    |          |
+--------------------+          |
        |                       |
        |                       |
        |                       |
+-------V-----+           +-----V-------+
| Service 1   |           | Service 2   |
| server_1    |           | server_2    |
| port 80     |           | port 80     |
+-------------+           +-------------+
        |                       |
        |                       |
        |                       |
+-------V-------+           +-----V---------+
| server_1      |           | server_2      |
| 192.168.10.10 |           | 192.168.10.11 |
+---------------+           +---------------+
</pre></div>


<p>In this setup the load balancer virtual server is configured with the
ROUNDROBIN load balancing method and has 2 service members with 50%
weight each.</p>
<p>To check that the load balancer works correctly run the following
command</p>
<div class="codehilite"><pre><span></span>curl <span class="m">10</span>.78.60.203
</pre></div>


<p>You should see a <code>Hello webserver1</code>. Running the same command a second
time should output <code>Hello webserver2</code>.</p>
<h2 id="upgrade-process"><a class="toclink" href="#upgrade-process">Upgrade process</a></h2>
<p>The upgrade playbook utilizes the <code>pre_tasks</code> and <code>post_tasks</code> hooks to
bring the services down and back up during the update process.</p>
<p>The upgrade playbook is the following:</p>
<div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">hosts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">service_hosts</span>
  <span class="l l-Scalar l-Scalar-Plain">vars</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">compose_yaml</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/var/tmp/docker-compose.yaml</span>

  <span class="l l-Scalar l-Scalar-Plain">remote_user</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
  <span class="l l-Scalar l-Scalar-Plain">gather_facts</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
  <span class="l l-Scalar l-Scalar-Plain">serial</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>

  <span class="l l-Scalar l-Scalar-Plain">pre_tasks</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Disable</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">servername</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">delegate_to</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
      <span class="l l-Scalar l-Scalar-Plain">netscaler_server</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">nsip</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nsip</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">nitro_user</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nitro_user</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">nitro_pass</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nitro_pass</span><span class="nv"> </span><span class="s">}}&quot;</span>

        <span class="l l-Scalar l-Scalar-Plain">disabled</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">servername</span><span class="nv"> </span><span class="s">}}&quot;</span>

  <span class="l l-Scalar l-Scalar-Plain">post_tasks</span><span class="p p-Indicator">:</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Re</span><span class="nv"> </span><span class="s">enable</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">servername</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">delegate_to</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
      <span class="l l-Scalar l-Scalar-Plain">netscaler_server</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">nsip</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nsip</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">nitro_user</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nitro_user</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">nitro_pass</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">nitro_pass</span><span class="nv"> </span><span class="s">}}&quot;</span>

        <span class="l l-Scalar l-Scalar-Plain">disabled</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
        <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">servername</span><span class="nv"> </span><span class="s">}}&quot;</span>

  <span class="l l-Scalar l-Scalar-Plain">tasks</span><span class="p p-Indicator">:</span>

    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="s">&quot;Update</span><span class="nv"> </span><span class="s">backend</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">servername</span><span class="nv"> </span><span class="s">}}&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">docker-compose -f &quot;{{ compose_yaml }}&quot; exec -d webserver bash -c &quot;echo &#39;hello updated {{ servername }}&#39; &gt; /app/content.txt&quot;</span>
</pre></div>


<p>The function of the pre_tasks and post_tasks hooks is documented by
<a href="https://docs.ansible.com/ansible/playbooks_roles.html">ansible</a>.</p>
<p>Essentially what we do is that we disable the server entity in Netscaler
for each web service before the update process and after the update has
taken place we re enable the server entity.</p>
<p>The <code>serial: 1</code> option instructs ansible to operate on the webservers
one at a time. This is a deviation from the default behavior of Ansible
which is to operate on multiple nodes at once.</p>
<p>In our example the update process is just a simple change of the content
file on the web service docker container to verify the update has taken
effect.</p>
<p>To see how the update works you can run</p>
<div class="codehilite"><pre><span></span>curl <span class="m">10</span>.78.60.203
</pre></div>


<p>during the update process and see how the output changes.</p>
<p>Since the update itself is a relatively quick process you may not be
able to see the rolling nature of the upgrade.</p>
<p>For that you may want to run the update script in step mode</p>
<div class="codehilite"><pre><span></span>ansible-playbook -i inventory.txt rolling_update.yml --step
</pre></div>


<p>and watch the output of</p>
<div class="codehilite"><pre><span></span>curl <span class="m">10</span>.78.60.203
</pre></div>


<p>a number of times to actually see what happens.</p>
<p>What you should see is each server taken out of the load balancing pool
and then brought up without any service interruption.</p>
<p>In our example the update of the web server is instantaneous we do not
have any actual down time.</p>
<p>In a real world situation the update would put the webserver in a state
that would be unable to respond to requests.</p>
<p>Had we not disabled the corresponding server, in this case, would mean
that a number of requests would be directed to the offline server
resulting in clients getting error responses.</p>
<p>Eventually the monitors attached to the Netscaler services would take
the disrupted service out of the load balancing pool but depending on
the traffic volume several requests would have been affected by the non
functioning service by that time.</p>
<p>Disabling the server before the update process guarantees that Netscaler
will not direct any traffic to it during that time, ensuring continuous
delivery of the content.</p>
<h2 id="references"><a class="toclink" href="#references">References</a></h2>
<ul>
<li><a href="https://github.com/citrix/netscaler-ansible-modules">Netscaler ansible modules repository</a></li>
<li><a href="https://docs.ansible.com/ansible/index.html">Ansible documentation</a></li>
</ul> 

                </div>
              </div>

            </div>
          </div>

        </section>

      </div>
    </div>
    <!--<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span class="prev"><a href="../rolling-upgrades/"><i class="fa fa-angle-left"></i> Previous</a></span>
      
      
        <span class="next"><a href="../docker-image/">Next <i class="fa fa-angle-right"></i></a></span>
      
    </span>
	<div class="footer-right">
		<ul class="social-links">
			<li class="list-inline"><a href="https://twitter.com/citrix"><i class="fa fa-twitter"></i>@citrix</a></li>
			<li class="list-inline"><a href="mailto:support@citrix.com"><i class="fa fa-envelope-o"></i>support@citrix.com</a></li>
		</ul>
		<ul class="inner-pages">
			<li class="list-inline"><a href="http://citrix.com/about/legal">Privacy and Terms</li>
		</ul>
	</div>
</div>-->

  </body>

</html>
