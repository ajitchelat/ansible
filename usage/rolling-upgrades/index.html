
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for Citrix NetScaler Ansible 0.1">
      
      
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.1, mkdocs-material-1.4.1">
    
    
      
        <title>Rolling upgrades - Citrix NetScaler Ansible Docs</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-56ade86843.js"></script>
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-76741b64bc.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../.." title="Citrix NetScaler Ansible Docs" class="md-icon md-icon--home md-header-nav__button">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  User Documentation
                </span>
              
            
            Rolling upgrades
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          
        </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-icon md-icon--home md-nav__button"></i>
    
    Citrix NetScaler Ansible Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="NetScaler Ansible Docs" class="md-nav__link">
      NetScaler Ansible Docs
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      User Documentation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        User Documentation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../getting-started/" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../speeding-up-execution/" title="Speeding up execution" class="md-nav__link">
      Speeding up execution
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Rolling upgrades
      </label>
    
    <a href="./" title="Rolling upgrades" class="md-nav__link md-nav__link--active">
      Rolling upgrades
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" title="Setup" class="md-nav__link">
    Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testbed" title="Testbed" class="md-nav__link">
    Testbed
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upgrade-process" title="Upgrade process" class="md-nav__link">
    Upgrade process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" title="References" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../rolling-upgrades-vpx/" title="Rolling upgrades (VPX)" class="md-nav__link">
      Rolling upgrades (VPX)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../docker-image/" title="Netscaler ansible docker image" class="md-nav__link">
      Netscaler ansible docker image
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Using Generic Ansible Modules
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Using Generic Ansible Modules
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../generic-modules/about/" title="Using generic Ansible modules" class="md-nav__link">
      Using generic Ansible modules
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../generic-modules/templating-configuration-file/" title="Templating the configuration file" class="md-nav__link">
      Templating the configuration file
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../generic-modules/nitro-api-calls/" title="Direct NITRO API calls" class="md-nav__link">
      Direct NITRO API calls
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../development-utilities/" title="Developer Documentation" class="md-nav__link">
      Developer Documentation
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" title="Setup" class="md-nav__link">
    Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testbed" title="Testbed" class="md-nav__link">
    Testbed
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#upgrade-process" title="Upgrade process" class="md-nav__link">
    Upgrade process
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references" title="References" class="md-nav__link">
    References
  </a>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="rolling-upgrades"><a class="toclink" href="#rolling-upgrades">Rolling upgrades</a></h1>
<p>This document demonstrates how to to a rolling upgrade with zero
downtime for a simple load balanced service.</p>
<p>The methods showcased here are also applicable to more complex
networking setups.</p>
<h2 id="setup"><a class="toclink" href="#setup">Setup</a></h2>
<p>The example utilizes Netscaler CPX and docker images.</p>
<p>The dependencies needed to run the playbooks are at
the following <a href="https://github.com/citrix/netscaler-rolling-updates-example">github repository</a></p>
<p>To create the docker containers from the checkout root run the following
<code>docker-compose up -d</code>.</p>
<p>To setup the cpx image you will need to run the rolling_init.yaml playbook
<code>ansible-playbook -i inventory.txt rolling_init.yaml</code></p>
<p>TIP: If you are running this using Docker for Mac or Docker for Windows, then ansible will not be able to reach the NetScaler CPX container on the specified IP in the inventory. You have to change the inventory.txt file to point to the actual port that the CPX API port is mapped to</p>
<div class="codehilite"><pre><span></span>docker port netscalerrollingupdatesexample_cpx_1
161/tcp -&gt; 0.0.0.0:32805
22/tcp -&gt; 0.0.0.0:32807
443/tcp -&gt; 0.0.0.0:32804
80/tcp -&gt; 0.0.0.0:32806
cat inventory.txt
    [all:vars]
    nsip=127.0.0.1:32806
</pre></div>


<p>This will initialize the testbed to the topology shown below.</p>
<h2 id="testbed"><a class="toclink" href="#testbed">Testbed</a></h2>
<p>The testbed is comprised of a Netscaler CPX load balancer and 2 docker containers
that act as the backend servers for the load balanced service.</p>
<p>The logical diagram of the testbed is as follows</p>
<div class="codehilite"><pre><span></span>                          +
                          |
                          |
                          |
                +---------V----------+
                | Load balancer      |
                | lb_vserver_1       |----------+
                | 172.30.0.200:8000  |          |
                +--------------------+          |
                        |                       |
                        |                       |
                        |                       |
                +-------V-----+           +-----V-------+
                | Service 1   |           | Service 2   |
                | server_1    |           | server_2    |
                | port 8000   |           | port 8000   |
                +-------------+           +-------------+
                        |                       |
                        |                       |
                        |                       |
                +-------V-----+           +-----V-------+
                | server_1    |           | server_2    |
                | 172.30.0.21 |           | 172.30.0.22 |
                +-------------+           +-------------+
                        |                       |
                        |                       |
                        |                       |
                        |                       |
                +-------V----------+    +-------V----------+
                | web server 1     |    | web server 2     |
                | 172.30.0.21:8000 |    | 172.30.0.22:8000 |
                +------------------+    +------------------+
</pre></div>


<p>In this setup the load balancer virtual server is configured with the
ROUNDROBIN load balancing method and has 2 service members with 50%
weight each.</p>
<p>To check that the load balancer works correctly run the following command</p>
<div class="codehilite"><pre><span></span>curl 172.30.0.200:8000
</pre></div>


<p>You should see a <code>Hello webapp1</code>.
Running the same a second time should output <code>Hello webapp2</code>.</p>
<p>TIP: If you are running this example using Docker for Mac or Docker for Windows, the docker network is not visible to your OS. In this case, use another container to execute this curl</p>
<div class="codehilite"><pre><span></span><span class="nt">docker</span> <span class="nt">run</span> <span class="nt">--rm</span> <span class="nt">--network</span><span class="o">=</span><span class="nt">netscalerrollingupdatesexample_netscaler</span> <span class="nt">--entrypoint</span> <span class="s2">&quot;/bin/sh&quot;</span>  <span class="nt">byrnedo</span><span class="o">/</span><span class="nt">alpine-curl</span> <span class="nt">-c</span> <span class="s2">&quot;while true; do curl  -s http://172.30.0.200:8000; sleep 1; done&quot;</span>
</pre></div>


<h2 id="upgrade-process"><a class="toclink" href="#upgrade-process">Upgrade process</a></h2>
<p>The upgrade playbook utilizes the <em>pre_tasks</em> and <em>post_tasks</em> hooks to
bring the services down and back up during the update process.</p>
<p>The upgrade playbook is the following:</p>
<div class="codehilite"><pre><span></span><span class="x">        - hosts: webservers</span>

<span class="x">          remote_user: root</span>
<span class="x">          gather_facts: False</span>
<span class="x">          serial: 1</span>

<span class="x">          pre_tasks:</span>
<span class="x">            - name: &quot;Disable </span><span class="cp">{{</span> <span class="nv">servername</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">              delegate_to: localhost</span>
<span class="x">              netscaler_server:</span>
<span class="x">                nsip: &quot;</span><span class="cp">{{</span> <span class="nv">nsip</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">                nitro_user: &quot;</span><span class="cp">{{</span> <span class="nv">nitro_user</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">                nitro_pass: &quot;</span><span class="cp">{{</span> <span class="nv">nitro_pass</span> <span class="cp">}}</span><span class="x">&quot;</span>

<span class="x">                disabled: yes</span>

<span class="x">                name: &quot;</span><span class="cp">{{</span> <span class="nv">servername</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">                ipaddress: &quot;</span><span class="cp">{{</span> <span class="nv">hostip</span> <span class="cp">}}</span><span class="x">&quot;</span>

<span class="x">          post_tasks:</span>

<span class="x">            - name: &quot;Re enable </span><span class="cp">{{</span> <span class="nv">servername</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">              delegate_to: localhost</span>
<span class="x">              netscaler_server:</span>
<span class="x">                nsip: &quot;</span><span class="cp">{{</span> <span class="nv">nsip</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">                nitro_user: &quot;</span><span class="cp">{{</span> <span class="nv">nitro_user</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">                nitro_pass: &quot;</span><span class="cp">{{</span> <span class="nv">nitro_pass</span> <span class="cp">}}</span><span class="x">&quot;</span>

<span class="x">                name: &quot;</span><span class="cp">{{</span> <span class="nv">servername</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">                ipaddress: &quot;</span><span class="cp">{{</span> <span class="nv">hostip</span> <span class="cp">}}</span><span class="x">&quot;</span>

<span class="x">          tasks:</span>

<span class="x">            - name: &quot;Update </span><span class="cp">{{</span> <span class="nv">servername</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">              delegate_to: localhost</span>
<span class="x">              command: docker-compose exec -d &quot;</span><span class="cp">{{</span> <span class="nv">servername</span> <span class="cp">}}</span><span class="x">&quot; bash -c &quot;echo &#39;hello updated </span><span class="cp">{{</span> <span class="nv">servername</span> <span class="cp">}}</span><span class="x">&#39; &gt; /app/content.txt&quot;</span>
</pre></div>


<p>The function of the pre_tasks and post_tasks hooks is documented by
<code>ansible &lt;https://docs.ansible.com/ansible/playbooks_roles.html&gt;</code>_.</p>
<p>Essentially what we do is that we disable the server entity in Netscaler
for each web service before the update process and after the update we
re enable the server entity.</p>
<p>The <code>serial: 1</code> option instructs ansible to operate on the webservers
one at a time. This is a deviation from the default behavior of Ansible
which is to operate on multiple nodes at once.</p>
<p>In our example the update process is just a simple change of the
content file on the web service docker container to verify
the update has taken effect.</p>
<p>To see how the update works you can run</p>
<div class="codehilite"><pre><span></span>curl 172.30.0.200:8000
</pre></div>


<p>during the update process and see how the output changes.</p>
<p>Since the update itself is a relatively quick process  you may
not be able to see the <code>rolling</code> nature of the upgrade.</p>
<p>For that you may want to run the update script in step mode</p>
<div class="codehilite"><pre><span></span>ansible-playbook -i inventory.txt rolling_update.yml --step
</pre></div>


<p>and watch the output of</p>
<div class="codehilite"><pre><span></span>curl 172.30.0.200:8000
</pre></div>


<p>a number of times to actually see what happens.</p>
<p>What you should see is each server taken out of the load balancing
pool and then brought up without any service interruption.</p>
<p>In our example the update of the web server is instantaneous
we do not have any down time.</p>
<p>In a real world situation the update would put the webserver in a
state that would be unable to respond to requests.</p>
<p>Had we not disabled the corresponding server, in this case, would
mean that a number of requests would be directed to the offline
server resulting in clients getting error responses.</p>
<p>Eventually the monitors attached to the Netscaler services would
take the disrupted service out of the load balancing pool
but depending on the traffic volume several requests would have
been affected by the non functioning service by that time.</p>
<p>Disabling the server before the update process guarantees that
Netscaler will not direct any traffic to it during that time,
ensuring continuous delivery of the content.</p>
<h2 id="references"><a class="toclink" href="#references">References</a></h2>
<ul>
<li><a href="https://github.com/citrix/netscaler-ansible-modules">Netscaler ansible modules repository</a></li>
<li><a href="https://docs.ansible.com/ansible/index.html">Ansible documentation</a></li>
</ul>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../speeding-up-execution/" title="Speeding up execution" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Speeding up execution
              </span>
            </div>
          </a>
        
        
          <a href="../rolling-upgrades-vpx/" title="Rolling upgrades (VPX)" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Rolling upgrades (VPX)
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-3964c0cb56.js"></script>
      <script>app.initialize({url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>